<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Tracker</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0;
            padding: 0;
        }
        /* Flexbox for full height layout */
        .min-h-screen {
            min-height: 100vh;
        }
        /* Custom animation for modal */
        .modal-enter-active, .modal-leave-active {
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .modal-enter-from, .modal-leave-to {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
        .modal-open .modal-enter-from, .modal-open .modal-leave-to {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
        .modal-open .modal-enter-active .modal-content,
        .modal-open .modal-leave-active .modal-content {
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .modal-open .modal-enter-from .modal-content,
        .modal-open .modal-leave-to .modal-content {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* NEW: Styles for hideable history section */
        #historyContent {
            max-height: 0;
            opacity: 0;
            overflow: hidden; /* Ensures content is clipped when collapsed */
            transition: max-height 0.4s ease-out, opacity 0.4s ease-out;
        }

        #historyContent.is-active {
            max-height: max-content; /* FIX: This will allow it to expand to content height */
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-purple-100 min-h-screen flex items-start justify-center pb-8">

    <div id="authModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 modal-enter-from">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full text-center border border-blue-300 modal-content">
            <h2 class="text-4xl font-extrabold text-gray-800 mb-6">Welcome to Finance Tracker</h2>
            <p class="text-gray-600 mb-6">Sign in or create an account to manage your finances.</p>
            <form id="authForm" class="space-y-5">
                <div>
                    <input
                        type="email"
                        id="authEmail"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-200"
                        placeholder="Email"
                        required
                    />
                </div>
                <div>
                    <input
                        type="password"
                        id="authPassword"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-200"
                        placeholder="Password"
                        required
                    />
                </div>
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                    <button
                        type="submit"
                        id="signInBtn"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 flex items-center justify-center"
                    >
                        Sign In <span id="signInLoader" class="loader hidden"></span>
                    </button>
                    <button
                        type="submit"
                        id="signUpBtn"
                        class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 flex items-center justify-center"
                    >
                        Sign Up <span id="signUpLoader" class="loader hidden"></span>
                    </button>
                </div>
            </form>
            <p id="authError" class="text-red-600 mt-4 text-sm font-semibold"></p>
        </div>
    </div>

    <div id="appContent" class="container max-w-3xl mx-auto p-6 bg-white rounded-2xl shadow-2xl border border-gray-200 hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight leading-tight">
                Finance Tracker
            </h1>
            <div id="userIdDisplay" class="flex items-center space-x-2">
                <p class="text-gray-600 text-sm hidden sm:block">
                    Logged in as: <span id="currentUserId" class="font-semibold text-blue-600 break-words"></span>
                </p>
                <button id="profileBtn" class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">
                    Profile
                </button>
            </div>
        </div>

        <div class="bg-gradient-to-r from-blue-600 to-purple-700 text-white p-6 rounded-xl shadow-xl mb-8 border border-blue-500">
            <h2 class="text-2xl font-bold mb-4 text-center">Your Monthly Snapshot</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                <div class="flex flex-col items-center justify-center p-2">
                    <p class="text-sm opacity-90">Income</p>
                    <p id="monthlyIncome" class="text-3xl font-extrabold mt-1">₹0.00</p>
                </div>
                <div class="flex flex-col items-center justify-center p-2">
                    <p class="text-sm opacity-90">Expenses</p>
                    <p id="monthlyExpenses" class="text-3xl font-extrabold mt-1">₹0.00</p>
                </div>
                <div class="flex flex-col items-center justify-center p-2">
                    <p id="monthlyBalance" class="text-3xl font-extrabold mt-1 transition-colors duration-300">₹0.00</p>
                </div>
            </div>
        </div>

        <div class="bg-indigo-50 p-6 rounded-xl shadow-lg mb-8 border border-indigo-200">
            <h2 class="text-2xl font-bold text-indigo-800 mb-4 text-center">Add New Transaction</h2>
            <div id="addTransactionButtons" class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                <button
                    id="addExpenseBtn"
                    class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 flex items-center justify-center space-x-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                    </svg>
                    <span>Add Expense</span>
                </button>
                <button
                    id="addIncomeBtn"
                    class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 flex items-center justify-center space-x-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                    </svg>
                    <span>Add Income</span>
                </button>
            </div>
        </div>

        <div class="bg-gray-50 p-6 rounded-xl shadow-lg border border-gray-200">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Transaction History</h2>
                <button id="toggleHistoryBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">
                    Show History
                </button>
            </div>

            <div id="historyContent">
                <div class="flex justify-end mb-2">
                    <button id="toggleFilterBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-4 rounded-lg shadow-sm transition duration-200">
                        Show Filters
                    </button>
                </div>
                <div id="filterSection" class="mb-6 bg-white p-4 rounded-lg shadow-sm border border-gray-300 hidden">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Filter Transactions</h3>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 items-end">
                        <div class="flex-1 w-full">
                            <label for="startDate" class="block text-gray-700 text-sm font-medium mb-1">Start Date</label>
                            <input type="date" id="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-400 focus:border-transparent outline-none transition duration-200">
                        </div>
                        <div class="flex-1 w-full">
                            <label for="endDate" class="block text-gray-700 text-sm font-medium mb-1">End Date</label>
                            <input type="date" id="endDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-400 focus:border-transparent outline-none transition duration-200">
                        </div>
                        <button id="applyFilterBtn" class="w-full sm:w-auto px-5 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-lg shadow-md transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                            Apply Filter
                        </button>
                        <button id="clearFilterBtn" class="w-full sm:w-auto px-5 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg shadow-md transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2">
                            Clear
                        </button>
                    </div>
                </div>

                <div id="transactionList" class="space-y-4 mb-6">
                    <p class="text-center text-gray-500 text-lg py-4">No transactions to display.</p>
                </div>

                <button id="loadMoreBtn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-lg shadow-md mb-6 hidden transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2">
                    Load More Transactions
                </button>

                <button id="exportToExcelBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Export to Excel (CSV)
                </button>
            </div>
        </div>
    </div>

    <div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-enter-from">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full text-center border border-gray-300 modal-content">
            <h3 id="modalTitle" class="text-2xl font-bold text-gray-800 mb-4"></h3>
            <p id="modalMessage" class="text-gray-600 text-lg mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirmActionBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                    Confirm
                </button>
                <button id="cancelActionBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg shadow-md transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="addTransactionModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden modal-enter-from">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full border border-blue-300 modal-content">
            <h3 id="addModalTitle" class="text-3xl font-bold text-gray-800 mb-6 text-center">Add New Transaction</h3>
            <form id="addTransactionForm" class="space-y-5">
                <div>
                    <label for="addDescription" class="block text-gray-700 text-lg font-medium mb-2">Description</label>
                    <input
                        type="text"
                        id="addDescription"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-200"
                        placeholder="e.g., Groceries, Salary, Rent"
                        required
                    />
                </div>
                <div>
                    <label for="addAmount" class="block text-gray-700 text-lg font-medium mb-2">Amount</label>
                    <input
                        type="number"
                        id="addAmount"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-200"
                        placeholder="e.g., 50.00"
                        step="0.01"
                        required
                    />
                </div>
                <div>
                    <label for="addDate" class="block text-gray-700 text-lg font-medium mb-2">Date</label>
                    <input
                        type="date"
                        id="addDate"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-200"
                        required
                    />
                </div>
                <p id="addError" class="text-red-600 mt-4 text-sm text-center font-semibold"></p>
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-6">
                    <button
                        type="submit"
                        id="confirmAddTransactionBtn"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 flex items-center justify-center"
                    >
                        Confirm Add <span id="addLoader" class="loader hidden"></span>
                    </button>
                    <button
                        type="button"
                        id="cancelAddModalBtn"
                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2"
                    >
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="editTransactionModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden modal-enter-from">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full border border-blue-300 modal-content">
            <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">Edit Transaction</h3>
            <form id="editTransactionForm" class="space-y-5">
                <div>
                    <label for="editDescription" class="block text-gray-700 text-lg font-medium mb-2">Description</label>
                    <input
                        type="text"
                        id="editDescription"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-200"
                        required
                    />
                </div>
                <div>
                    <label for="editAmount" class="block text-gray-700 text-lg font-medium mb-2">Amount</label>
                    <input
                        type="number"
                        id="editAmount"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-200"
                        step="0.01"
                        required
                    />
                </div>
                <div>
                    <label for="editDate" class="block text-gray-700 text-lg font-medium mb-2">Date</label>
                    <input
                        type="date"
                        id="editDate"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-200"
                        required
                    />
                </div>
                <p id="editError" class="text-red-600 mt-4 text-sm text-center font-semibold"></p>
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-6">
                    <button
                        type="submit"
                        id="saveEditBtn"
                        class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 flex items-center justify-center"
                    >
                        Save Changes <span id="editLoader" class="loader hidden"></span>
                    </button>
                    <button
                        type="button"
                        id="cancelEditModalBtn"
                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2"
                    >
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Gemini AI Assistant Button (hidden by default) -->
    <button id="geminiOpenBtn" class="fixed bottom-6 right-6 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full shadow-lg p-3 z-50 flex items-center justify-center"
            style="display: block;">
        <!-- Chat icon SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.77 9.77 0 01-4-.8L3 21l1.8-4A8.96 8.96 0 013 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
    </button>

    <!-- Gemini Chat Popup (hidden by default) -->
    <div id="geminiChat" class="fixed bottom-4 right-4 bg-white rounded-xl shadow-lg p-4 w-80 border border-gray-300 z-50"
         style="display: none;">
        <div class="flex justify-between items-center mb-2">
            <h3 class="font-bold text-indigo-700">Gemini AI Assistant</h3>
            <button id="geminiCloseBtn" class="text-gray-400 hover:text-red-500 text-xl font-bold ml-2" title="Close">&times;</button>
        </div>
        <div id="geminiMessages" class="h-40 overflow-y-auto mb-2 text-sm"></div>
        <form id="geminiForm" class="flex">
            <input id="geminiInput" type="text" class="flex-1 border rounded-l px-2 py-1" placeholder="Ask Gemini..." required>
            <button type="submit" class="bg-indigo-600 text-white px-3 py-1 rounded-r">Send</button>
        </form>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCl6ubGzBbeiJv1vYSuGCFmeqvQRyQeDRM", // Replace with your Firebase API Key
            authDomain: "expensetracker-e711b.firebaseapp.com",
            projectId: "expensetracker-e711b",
            storageBucket: "expensetracker-e711b.firebasestorage.app",
            messagingSenderId: "742011057310",
            appId: "1:742011057310:web:86e4f6ef2f48977dfdf78f"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        // Global variables for Firebase instances
        let db = getFirestore(app);
        let auth = getAuth(app);
        let currentUserId = null;
        let currentUserEmail = null;
        let allTransactions = [];
        let transactionBeingEditedId = null; // To store the ID of the transaction being edited
        let currentAddTransactionType = null; // To store 'income' or 'expense' when adding

        let transactionsDisplayLimit = 5; // NEW GLOBAL VARIABLE

        // Global variable to store the unsubscribe function for Firestore listener
        let unsubscribeFromTransactions = null;


        // Get DOM elements for Auth
        const authModal = document.getElementById('authModal');
        const authForm = document.getElementById('authForm');
        const authEmailInput = document.getElementById('authEmail');
        const authPasswordInput = document.getElementById('authPassword');
        const signInBtn = document.getElementById('signInBtn');
        const signUpBtn = document.getElementById('signUpBtn');
        const authError = document.getElementById('authError');
        const appContent = document.getElementById('appContent');
        const profileBtn = document.getElementById('profileBtn');

        // NEW: Loaders for auth buttons
        const signInLoader = document.getElementById('signInLoader');
        const signUpLoader = document.getElementById('signUpLoader');


        // Get DOM elements for Finance Tracker (some changed/removed)
        const addExpenseBtn = document.getElementById('addExpenseBtn');
        const addIncomeBtn = document.getElementById('addIncomeBtn');

        const transactionListDiv = document.getElementById('transactionList');
        const monthlyIncomeSpan = document.getElementById('monthlyIncome');
        const monthlyExpensesSpan = document.getElementById('monthlyExpenses');
        const monthlyBalanceSpan = document.getElementById('monthlyBalance');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const applyFilterBtn = document.getElementById('applyFilterBtn');
        const clearFilterBtn = document.getElementById('clearFilterBtn');
        const exportToExcelBtn = document.getElementById('exportToExcelBtn');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const currentUserIdSpan = document.getElementById('currentUserId');
        const loadMoreBtn = document.getElementById('loadMoreBtn');

        // NEW DOM elements for toggling history
        const toggleHistoryBtn = document.getElementById('toggleHistoryBtn');
        const historyContent = document.getElementById('historyContent');


        // New DOM elements for Add Transaction Modal
        const addTransactionModal = document.getElementById('addTransactionModal');
        const addModalTitle = document.getElementById('addModalTitle');
        const addTransactionForm = document.getElementById('addTransactionForm');
        const addDescriptionInput = document.getElementById('addDescription');
        const addAmountInput = document.getElementById('addAmount');
        const addDateInput = document.getElementById('addDate');
        const confirmAddTransactionBtn = document.getElementById('confirmAddTransactionBtn');
        const cancelAddModalBtn = document.getElementById('cancelAddModalBtn');
        const addError = document.getElementById('addError');
        const addLoader = document.getElementById('addLoader');


        // Existing DOM elements for Edit Transaction Modal
        const editTransactionModal = document.getElementById('editTransactionModal');
        const editTransactionForm = document.getElementById('editTransactionForm');
        const editDescriptionInput = document.getElementById('editDescription');
        const editAmountInput = document.getElementById('editAmount');
        const editDateInput = document.getElementById('editDate');
        const saveEditBtn = document.getElementById('saveEditBtn');
        const cancelEditModalBtn = document.getElementById('cancelEditModalBtn');
        const editError = document.getElementById('editError');
        const editLoader = document.getElementById('editLoader');


        // Modal elements for confirmations
        const confirmationModal = document.getElementById('confirmationModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const confirmActionBtn = document.getElementById('confirmActionBtn');
        const cancelActionBtn = document.getElementById('cancelActionBtn');

        // Utility function to toggle modal visibility and apply animation classes
        function toggleModal(modalElement, show) {
            const modalContent = modalElement.querySelector('.modal-content');

            if (show) {
                modalElement.classList.remove('hidden');
                // Force reflow to apply 'modal-enter-from' before 'modal-enter-active'
                void modalElement.offsetWidth;
                modalElement.classList.add('modal-enter-active');
                modalElement.classList.remove('modal-enter-from');

                if (modalContent) {
                    void modalContent.offsetWidth; // Force reflow for content
                    modalContent.classList.add('modal-enter-active');
                    modalContent.classList.remove('modal-enter-from');
                }
            } else {
                modalElement.classList.add('modal-leave-active');
                modalElement.classList.add('modal-leave-to');
                modalElement.classList.remove('modal-enter-active');

                if (modalContent) {
                    modalContent.classList.add('modal-leave-active');
                    modalContent.classList.add('modal-leave-to');
                    modalContent.classList.remove('modal-enter-active');
                }

                const handleTransitionEnd = () => {
                    modalElement.classList.add('hidden');
                    modalElement.classList.remove('modal-leave-active', 'modal-leave-to');
                    if (modalContent) {
                        modalContent.classList.remove('modal-leave-active', 'modal-leave-to');
                    }
                    modalElement.removeEventListener('transitionend', handleTransitionEnd);
                };

                // Listen for transition end on the main modal element
                modalElement.addEventListener('transitionend', handleTransitionEnd, { once: true });
            }
        }

        // Function to show custom confirmation modal
        function showModal(title, message, onConfirm, confirmText = "Confirm", cancelText = "Cancel") {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            confirmActionBtn.textContent = confirmText;
            cancelActionBtn.textContent = cancelText;

            toggleModal(confirmationModal, true);

            let currentConfirmHandler = null;
            let currentCancelHandler = null;

            currentConfirmHandler = () => {
                onConfirm();
                toggleModal(confirmationModal, false);
                confirmActionBtn.removeEventListener('click', currentConfirmHandler);
                cancelActionBtn.removeEventListener('click', currentCancelHandler);
                confirmActionBtn.textContent = "Confirm"; // Reset button texts
                cancelActionBtn.textContent = "Cancel";
            };

            currentCancelHandler = () => {
                toggleModal(confirmationModal, false);
                confirmActionBtn.removeEventListener('click', currentConfirmHandler);
                cancelActionBtn.removeEventListener('click', currentCancelHandler);
                confirmActionBtn.textContent = "Confirm"; // Reset button texts
                cancelActionBtn.textContent = "Cancel";
            };

            // Remove existing listeners before adding new ones to prevent multiple calls
            // Using a unique property on window to store handlers safely
            if (window._tempConfirmHandler) {
                confirmActionBtn.removeEventListener('click', window._tempConfirmHandler);
                cancelActionBtn.removeEventListener('click', window._tempCancelHandler);
            }

            confirmActionBtn.addEventListener('click', currentConfirmHandler);
            cancelActionBtn.addEventListener('click', currentCancelHandler);

            window._tempConfirmHandler = currentConfirmHandler;
            window._tempCancelHandler = currentCancelHandler;
        }

        // --- Authentication Functions ---

        // Handle Sign In
        signInBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            authError.textContent = ''; // Clear previous errors
            signInBtn.disabled = true; // Disable button
            signInLoader.classList.remove('hidden'); // Show loader

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Sign In Error:", error);
                authError.textContent = error.message;
            } finally {
                signInBtn.disabled = false; // Re-enable button
                signInLoader.classList.add('hidden'); // Hide loader
            }
        });

        // Handle Sign Up
        signUpBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            authError.textContent = ''; // Clear previous errors
            signUpBtn.disabled = true; // Disable button
            signUpLoader.classList.remove('hidden'); // Show loader

            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Sign Up Error:", error);
                authError.textContent = error.message;
            } finally {
                signUpBtn.disabled = false; // Re-enable button
                signUpLoader.classList.add('hidden'); // Hide loader
            }
        });

        // Handle Profile Button click (now triggers logout modal)
        profileBtn.addEventListener('click', async () => {
            showModal(
                "User Profile",
                `You are logged in as: ${currentUserEmail}`,
                async () => {
                    try {
                        await signOut(auth);
                    } catch (error) {
                        console.error("Logout Error:", error);
                        showModal("Logout Error", "Failed to log out. Please try again.", () => {}, "Ok");
                    }
                },
                "Logout", // Text for the confirm button
                "Close"   // Text for the cancel button
            );
        });

        // --- Firebase Initialization and Auth State Listener ---
        window.onload = () => {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in
                    currentUserId = user.uid;
                    currentUserEmail = user.email || 'N/A'; // Use email or fallback
                    currentUserIdSpan.textContent = currentUserEmail;
                    userIdDisplay.classList.remove('hidden');
                    toggleModal(authModal, false); // Hide auth modal with animation
                    appContent.classList.remove('hidden'); // Show app content
                    console.log("Logged in as:", currentUserEmail, "(UID:", currentUserId, ")");
                    transactionsDisplayLimit = 5; // Reset limit on login
                    // Start listening for data and store the unsubscribe function
                    unsubscribeFromTransactions = listenForTransactions();
                } else {
                    // User is signed out
                    // First, stop listening to old data if it exists
                    if (unsubscribeFromTransactions) {
                        unsubscribeFromTransactions();
                        unsubscribeFromTransactions = null;
                        console.log("Stopped listening to transactions.");
                    }
                    currentUserId = null;
                    currentUserEmail = null;
                    userIdDisplay.classList.add('hidden');
                    toggleModal(authModal, true); // Show auth modal with animation
                    appContent.classList.add('hidden'); // Hide app content
                    allTransactions = []; // Clear transactions when logged out
                    displayTransactions([]); // Clear displayed transactions
                    updateMonthlySummary(); // Reset summary
                    console.log("No user logged in.");
                }
            });
        };

        // Function to listen for real-time transaction updates from Firestore
        function listenForTransactions() {
            if (!db || !currentUserId) {
                console.error("Firestore DB or User ID not available for listening.");
                // Return a no-op unsubscribe function if conditions are not met
                return () => {};
            }

            const transactionsCollectionRef = collection(db, `users/${currentUserId}/transactions`);
            const q = query(transactionsCollectionRef);

            // onSnapshot returns an unsubscribe function
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const transactionsData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                transactionsData.sort((a, b) => new Date(b.date) - new Date(a.date));
                allTransactions = transactionsData;

                applyCurrentFilterAndDisplay();
                updateMonthlySummary();
            }, (error) => {
                console.error("Error fetching transactions in onSnapshot:", error);
                // Only show modal if still authenticated (i.e., not caused by logout cleanup)
                if (currentUserId) {
                    showModal("Data Fetch Error", "Failed to load transactions. Please check your internet connection.", () => {}, "Ok");
                }
            });

            return unsubscribe; // Return the unsubscribe function
        }

        // Function to display transactions based on current filters
        function applyCurrentFilterAndDisplay() {
            let filteredTransactions = [...allTransactions];

            const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

            let isFilterActive = false;
            if (startDate || endDate) {
                isFilterActive = true;
                filteredTransactions = filteredTransactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    const startOfDay = startDate ? new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate()) : null;
                    const endOfDay = endDate ? new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate(), 23, 59, 59, 999) : null;

                    const matchesStart = startOfDay ? transactionDate >= startOfDay : true;
                    const matchesEnd = endOfDay ? transactionDate <= endOfDay : true;

                    return matchesStart && matchesEnd;
                });
            }

            // If no date filter is active, only show up to transactionsDisplayLimit
            let transactionsToShow = filteredTransactions;
            if (!isFilterActive) {
                transactionsToShow = filteredTransactions.slice(0, transactionsDisplayLimit);
                // Show/hide load more button
                if (transactionsDisplayLimit < filteredTransactions.length) {
                    loadMoreBtn.classList.remove('hidden');
                } else {
                    loadMoreBtn.classList.add('hidden');
                }
            } else {
                // If a filter is applied, always show all filtered results and hide load more
                loadMoreBtn.classList.add('hidden');
            }

            displayTransactions(transactionsToShow); // Pass the potentially sliced array
        }

        // Function to render transactions to the UI
        function displayTransactions(transactionsToDisplay) {
            transactionListDiv.innerHTML = ''; // Clear existing list

            if (transactionsToDisplay.length === 0) {
                transactionListDiv.innerHTML = '<p class="text-center text-gray-500 text-lg py-4">No transactions to display.</p>';
                return;
            }

            transactionsToDisplay.forEach(transaction => {
                const listItem = document.createElement('div');
                // Added hover effect, increased shadow, and border for a card-like look
                const borderColorClass = transaction.type === 'income' ? 'border-green-400' : 'border-red-400'; // Dynamic border color
                listItem.classList.add(
                    'flex', 'justify-between', 'items-center', 'p-4', 'rounded-lg', 'bg-white',
                    'shadow-lg', 'border-l-4', borderColorClass, // Stronger shadow and colored left border
                    'flex-wrap', 'sm:flex-nowrap',
                    'hover:shadow-xl', 'transition', 'duration-200', 'ease-in-out', 'transform', 'hover:-translate-y-1',
                    'mb-3' // Added margin-bottom for spacing between cards
                );

                const amountClass = transaction.type === 'expense' ? 'text-red-600' : 'text-green-600';
                const sign = transaction.type === 'expense' ? '-' : '+';

                listItem.innerHTML = `
                    <div class="flex flex-col flex-grow min-w-0 mr-4 py-1">
                        <span class="text-gray-800 font-bold text-lg truncate">${transaction.description}</span>
                        <span class="text-gray-500 text-sm">${transaction.date}</span>
                    </div>
                    <span class="${amountClass} font-extrabold text-xl sm:text-2xl mr-4 text-right flex-shrink-0 py-1">
                        ${sign} ₹${transaction.amount.toFixed(2)}
                    </span>
                    <div class="flex space-x-2 flex-shrink-0 ml-auto py-1">
                        <button class="edit-btn bg-yellow-500 hover:bg-yellow-600 text-white p-2 rounded-md shadow-sm transition duration-200 hover:scale-105" data-id="${transaction.id}" title="Edit Transaction">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                        </button>
                        <button class="delete-btn bg-red-500 hover:bg-red-600 text-white p-2 rounded-md shadow-sm transition duration-200 hover:scale-105" data-id="${transaction.id}" title="Delete Transaction">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                `;
                transactionListDiv.appendChild(listItem);
            });

            // Attach event listeners to new buttons (delegation or direct after rendering)
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.currentTarget.dataset.id;
                    const transactionToEdit = allTransactions.find(t => t.id === id);
                    if (transactionToEdit) {
                        handleEditTransaction(transactionToEdit);
                    }
                };
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.currentTarget.dataset.id;
                    showModal(
                        "Confirm Deletion",
                        "Are you sure you want to delete this transaction? This action cannot be undone.",
                        () => handleDeleteTransaction(id),
                        "Delete",
                        "Cancel"
                    );
                };
            });
        }
        // Function to update monthly summary
        function updateMonthlySummary() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            let totalIncome = 0;
            let totalExpenses = 0;

            allTransactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date);
                if (transactionDate.getMonth() === currentMonth && transactionDate.getFullYear() === currentYear) {
                    if (transaction.type === 'income') {
                        totalIncome += transaction.amount;
                    } else if (transaction.type === 'expense') {
                        totalExpenses += transaction.amount;
                    }
                }
            });

            const netBalance = totalIncome - totalExpenses;

            monthlyIncomeSpan.textContent = `₹${totalIncome.toFixed(2)}`;
            monthlyExpensesSpan.textContent = `₹${totalExpenses.toFixed(2)}`;
            monthlyBalanceSpan.textContent = `₹${netBalance.toFixed(2)}`;

            // Change color of net balance based on value
            // More contrasting colors on the darker gradient background
            if (netBalance >= 0) {
                monthlyBalanceSpan.classList.remove('text-red-300', 'text-red-400');
                monthlyBalanceSpan.classList.add('text-green-200');
            } else {
                monthlyBalanceSpan.classList.remove('text-green-200');
                monthlyBalanceSpan.classList.add('text-red-400');
            }
        }

        // --- New Functions for Add Transaction Modal ---

        // Function to open the Add Transaction modal
        function openAddTransactionModal(type) {
            currentAddTransactionType = type;
            addModalTitle.textContent = `Add New ${type === 'income' ? 'Income' : 'Expense'}`;
            // Pre-fill date with today's date
            addDateInput.value = new Date().toISOString().slice(0, 10);
            addDescriptionInput.value = '';
            addAmountInput.value = '';
            addError.textContent = ''; // Clear previous errors
            toggleModal(addTransactionModal, true);
            addLoader.classList.add('hidden'); // Hide loader
            confirmAddTransactionBtn.disabled = false; // Enable button
        }

        // Event listener for "Add Expense" button
        addExpenseBtn.addEventListener('click', () => {
            openAddTransactionModal('expense');
        });

        // Event listener for "Add Income" button
        addIncomeBtn.addEventListener('click', () => {
            openAddTransactionModal('income');
        });

        // Event listener for "Confirm Add" button inside the Add Transaction modal
        addTransactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!db || !currentUserId || !currentAddTransactionType) {
                console.error("Firebase not initialized, user not authenticated, or transaction type not set.");
                addError.textContent = "Error: Cannot add transaction. Please try again.";
                return;
            }

            const description = addDescriptionInput.value.trim();
            const amount = parseFloat(addAmountInput.value);
            const date = addDateInput.value;
            const type = currentAddTransactionType; // Use the stored type

            if (!description || isNaN(amount) || amount <= 0 || !date) {
                addError.textContent = "Please fill in all fields correctly. Amount must be a positive number.";
                return;
            }

            addLoader.classList.remove('hidden'); // Show loader
            confirmAddTransactionBtn.disabled = true; // Disable button

            try {
                await addDoc(collection(db, `users/${currentUserId}/transactions`), {
                    description: description,
                    amount: amount,
                    date: date,
                    type: type,
                    userId: currentUserId,
                    timestamp: serverTimestamp()
                });
                console.log("Transaction successfully added!");
                resetAddModal(); // Close modal and reset fields
            } catch (error) {
                console.error("Error adding document: ", error);
                addError.textContent = "Failed to add transaction. Please try again.";
            } finally {
                addLoader.classList.add('hidden'); // Hide loader
                confirmAddTransactionBtn.disabled = false; // Re-enable button
            }
        });

        // Event listener for "Cancel" button in the Add Transaction modal
        cancelAddModalBtn.addEventListener('click', () => {
            resetAddModal();
        });

        // Function to reset and hide the Add Transaction modal
        function resetAddModal() {
            addDescriptionInput.value = '';
            addAmountInput.value = '';
            addDateInput.value = '';
            addError.textContent = '';
            currentAddTransactionType = null;
            toggleModal(addTransactionModal, false);
        }


        // --- Existing Functions for Edit/Delete ---

        // Function to handle editing a transaction (shows modal)
        function handleEditTransaction(transaction) {
            transactionBeingEditedId = transaction.id; // Store ID of transaction being edited
            editDescriptionInput.value = transaction.description;
            editAmountInput.value = transaction.amount;
            editDateInput.value = transaction.date;
            editError.textContent = ''; // Clear previous errors

            toggleModal(editTransactionModal, true);
            editLoader.classList.add('hidden'); // Hide loader
            saveEditBtn.disabled = false; // Enable button
        }

        // Function to handle deleting a transaction
        async function handleDeleteTransaction(transactionId) {
            if (!db || !currentUserId) {
                console.error("Firebase not initialized or user not authenticated.");
                showModal("Error", "Firebase not ready. Please sign in.", () => {}, "Ok");
                return;
            }
            try {
                // Construct the document reference
                const docRef = doc(db, `users/${currentUserId}/transactions`, transactionId);
                await deleteDoc(docRef);
                console.log("Document successfully deleted!");
                // onSnapshot will automatically update the UI
            } catch (error) {
                console.error("Error removing document: ", error);
                showModal("Error", "Failed to delete transaction. Please try again.", () => {}, "Ok");
            }
        }

        // Function to reset the edit modal and related state
        function resetEditModal() {
            transactionBeingEditedId = null;
            editDescriptionInput.value = '';
            editAmountInput.value = '';
            editDateInput.value = '';
            editError.textContent = '';
            toggleModal(editTransactionModal, false);
        }

        // Event listener for Save Changes button in edit modal
        saveEditBtn.addEventListener('click', async (e) => {
            e.preventDefault();

            if (!db || !currentUserId || !transactionBeingEditedId) {
                console.error("Cannot update: Firebase not ready or no transaction selected for edit.");
                editError.textContent = "Error: No transaction selected for edit.";
                return;
            }

            const description = editDescriptionInput.value.trim();
            const amount = parseFloat(editAmountInput.value);
            const date = editDateInput.value;

            if (!description || isNaN(amount) || amount <= 0 || !date) {
                editError.textContent = "Please fill in all fields correctly. Amount must be a positive number.";
                return;
            }

            editLoader.classList.remove('hidden'); // Show loader
            saveEditBtn.disabled = true; // Disable button

            try {
                const docRef = doc(db, `users/${currentUserId}/transactions`, transactionBeingEditedId);
                await updateDoc(docRef, {
                    description: description,
                    amount: amount,
                    date: date,
                    // Note: Type is not changed during edit to keep it consistent
                });
                console.log("Document successfully updated!");
                resetEditModal(); // Close modal and reset fields
            } catch (error) {
                console.error("Error updating document: ", error);
                editError.textContent = "Failed to update transaction. Please try again.";
            } finally {
                editLoader.classList.add('hidden'); // Hide loader
                saveEditBtn.disabled = false; // Re-enable button
            }
        });

        // Event listener for Cancel button in edit modal
        cancelEditModalBtn.addEventListener('click', () => {
            resetEditModal();
        });

        // Event listener for Apply Filter button
        applyFilterBtn.addEventListener('click', applyCurrentFilterAndDisplay);

        // Event listener for Clear Filter button
        clearFilterBtn.addEventListener('click', () => {
            startDateInput.value = '';
            endDateInput.value = '';
            transactionsDisplayLimit = 5; // Reset limit on clear filter
            applyCurrentFilterAndDisplay();
        });

        // Event listener for Load More button
        loadMoreBtn.addEventListener('click', () => {
            transactionsDisplayLimit += 10; // Increase limit by 10
            applyCurrentFilterAndDisplay(); // Re-apply filter and re-render
        });

        // NEW: Event listener for Toggle History button
        toggleHistoryBtn.addEventListener('click', () => {
            console.log("Toggle history button clicked!"); // Debug log
            historyContent.classList.toggle('is-active'); // Toggle the new class
            if (historyContent.classList.contains('is-active')) {
                toggleHistoryBtn.textContent = 'Hide History';
            } else {
                toggleHistoryBtn.textContent = 'Show History';
            }
            console.log("History content classes:", historyContent.classList); // Debug log
        });


        // NEW: Toggle Filter Section
        const toggleFilterBtn = document.getElementById('toggleFilterBtn');
        const filterSection = document.getElementById('filterSection');

        toggleFilterBtn.addEventListener('click', () => {
            filterSection.classList.toggle('hidden');
            if (filterSection.classList.contains('hidden')) {
                toggleFilterBtn.textContent = 'Show Filters';
            } else {
                toggleFilterBtn.textContent = 'Hide Filters';
            }
        });

        // Function to export data to CSV
        exportToExcelBtn.addEventListener('click', () => {
            if (allTransactions.length === 0) {
                showModal("No Data", "There is no data to export.", () => {}, "Ok");
                return;
            }

            // Define CSV header
            const header = ['Type', 'Description', 'Amount', 'Date', 'UserID'];
            let csvContent = header.map(h => `"${h}"`).join(',') + '\n'; // Quote headers too

            // Add rows
            allTransactions.forEach(transaction => {
                const row = [
                    transaction.type,
                    `"${transaction.description.replace(/"/g, '""')}"`, // Handle quotes in description
                    transaction.amount.toFixed(2),
                    transaction.date,
                    transaction.userId
                ];
                csvContent += row.join(',') + '\n';
            });

            // Create a Blob and a download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'finance_transactions.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        });

        // PWA: Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered! Scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
        // End PWA registration

        const geminiForm = document.getElementById('geminiForm');
        const geminiInput = document.getElementById('geminiInput');
        const geminiMessages = document.getElementById('geminiMessages');

        geminiForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMsg = geminiInput.value.trim();
            if (!userMsg) return;
            geminiMessages.innerHTML += `<div class="mb-1"><b>You:</b> ${userMsg}</div>`;
            geminiInput.value = '';
            geminiMessages.innerHTML += `<div class="mb-1 text-gray-400">Gemini is typing...</div>`;
            geminiMessages.scrollTop = geminiMessages.scrollHeight;

            // Use Gemini 2.5 Flash model and your actual API key from Google AI Studio
            const apiKey = 'AIzaSyB6GKF6P3CRlU8UEfX881QcsHpe_JxSVZk'; // Replace with your actual key
            const url = 'https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=' + apiKey;

            const body = {
                contents: [{ parts: [{ text: userMsg }] }]
            };

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                const geminiText = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response.';
                geminiMessages.innerHTML += `<div class="mb-2"><b>Gemini:</b> ${geminiText}</div>`;
            } catch (err) {
                geminiMessages.innerHTML += `<div class="mb-2 text-red-500">Error: ${err.message}</div>`;
            }
            geminiMessages.scrollTop = geminiMessages.scrollHeight;
        });

        // Gemini AI Assistant popup logic
        const geminiOpenBtn = document.getElementById('geminiOpenBtn');
        const geminiChat = document.getElementById('geminiChat');
        const geminiCloseBtn = document.getElementById('geminiCloseBtn');

        // Hide chat by default, show only the button
        geminiChat.style.display = 'none';
        geminiOpenBtn.style.display = 'block';

        // Open Gemini chat popup
        geminiOpenBtn.addEventListener('click', () => {
            geminiChat.style.display = 'block';
            geminiOpenBtn.style.display = 'none';
        });

        // Close Gemini chat popup
        geminiCloseBtn.addEventListener('click', () => {
            geminiChat.style.display = 'none';
            geminiOpenBtn.style.display = 'block';
        });
    </script>
</body>
</html>
