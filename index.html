<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Tracker</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0;
            padding: 0;
        }
        /* Flexbox for full height layout */
        .min-h-screen {
            min-height: 100vh;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-purple-100 min-h-screen flex items-start justify-center pb-8">

    <div id="authModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full text-center border border-blue-300">
            <h2 class="text-4xl font-extrabold text-gray-800 mb-6">Welcome to Finance Tracker</h2>
            <p class="text-gray-600 mb-6">Sign in or create an account to manage your finances.</p>
            <form id="authForm" class="space-y-5">
                <div>
                    <input
                        type="email"
                        id="authEmail"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-200"
                        placeholder="Email"
                        required
                    />
                </div>
                <div>
                    <input
                        type="password"
                        id="authPassword"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-200"
                        placeholder="Password"
                        required
                    />
                </div>
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                    <button
                        type="submit"
                        id="signInBtn"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                    >
                        Sign In
                    </button>
                    <button
                        type="submit"
                        id="signUpBtn"
                        class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                    >
                        Sign Up
                    </button>
                </div>
            </form>
            <p id="authError" class="text-red-500 mt-4 text-sm"></p>
        </div>
    </div>

    <div id="appContent" class="container max-w-4xl mx-auto p-6 bg-white rounded-2xl shadow-2xl border border-gray-200 hidden">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-8 text-center tracking-tight leading-tight">
            Personal Finance Tracker
        </h1>

        <div id="userIdDisplay" class="bg-gray-50 p-3 rounded-xl shadow-inner mb-6 text-center flex justify-between items-center">
            <p class="text-gray-600 text-sm">
                Logged in as: <span id="currentUserId" class="font-semibold text-blue-600 break-words"></span>
            </p>
            <button id="profileBtn" class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">
                Profile
            </button>
        </div>

        <div class="bg-purple-50 p-6 rounded-xl shadow-lg mb-8 border border-purple-200">
            <h2 class="text-3xl font-bold text-purple-800 mb-4 text-center">This Month's Summary</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                <div class="bg-white p-4 rounded-lg shadow-sm border border-green-200">
                    <p class="text-lg text-gray-600">Total Income</p>
                    <p id="monthlyIncome" class="text-3xl font-extrabold text-green-700 mt-1">₹0.00</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-red-200">
                    <p class="text-lg text-gray-600">Total Expenses</p>
                    <p id="monthlyExpenses" class="text-3xl font-extrabold text-red-700 mt-1">₹0.00</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-blue-200">
                    <p class="text-lg text-gray-600">Net Balance</p>
                    <p id="monthlyBalance" class="text-3xl font-extrabold text-blue-700 mt-1">₹0.00</p>
                </div>
            </div>
        </div>

        <div class="bg-indigo-50 p-8 rounded-xl shadow-lg mb-8 border border-indigo-200">
            <h2 class="text-3xl font-bold text-indigo-800 mb-6 text-center">Add New Transaction</h2>
            <div id="addTransactionButtons" class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <button
                    id="addExpenseBtn"
                    class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
                >
                    Add Expense
                </button>
                <button
                    id="addIncomeBtn"
                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
                >
                    Add Income
                </button>
            </div>
        </div>

        <div class="bg-gray-50 p-8 rounded-xl shadow-lg border border-gray-200">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Transaction History</h2>

            <div class="mb-6 bg-white p-5 rounded-lg shadow-sm border border-gray-300">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Filter Transactions</h3>
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 items-end">
                    <div class="flex-1 w-full">
                        <label for="startDate" class="block text-gray-700 text-sm font-medium mb-1">Start Date</label>
                        <input type="date" id="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-400 focus:border-transparent outline-none">
                    </div>
                    <div class="flex-1 w-full">
                        <label for="endDate" class="block text-gray-700 text-sm font-medium mb-1">End Date</label>
                        <input type="date" id="endDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-400 focus:border-transparent outline-none">
                    </div>
                    <button id="applyFilterBtn" class="w-full sm:w-auto px-5 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-lg shadow-md transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        Apply Filter
                    </button>
                    <button id="clearFilterBtn" class="w-full sm:w-auto px-5 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg shadow-md transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2">
                        Clear Filter
                    </button>
                </div>
            </div>

            <div id="transactionList" class="space-y-3 mb-6">
                <p class="text-center text-gray-500 text-lg">No transactions yet. Add some!</p>
            </div>

            <button id="loadMoreBtn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-lg shadow-md mb-6 hidden transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2">
                Load More Transactions
            </button>

            <button id="exportToExcelBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Export to Excel (CSV)
            </button>
        </div>
    </div>

    <div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full text-center border border-gray-300">
            <h3 id="modalTitle" class="text-2xl font-bold text-gray-800 mb-4"></h3>
            <p id="modalMessage" class="text-gray-600 text-lg mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirmActionBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                    Confirm
                </button>
                <button id="cancelActionBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg shadow-md transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="addTransactionModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full border border-blue-300">
            <h3 id="addModalTitle" class="text-3xl font-bold text-gray-800 mb-6 text-center">Add New Transaction</h3>
            <form id="addTransactionForm" class="space-y-5">
                <div>
                    <label for="addDescription" class="block text-gray-700 text-lg font-medium mb-2">Description</label>
                    <input
                        type="text"
                        id="addDescription"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-200"
                        placeholder="e.g., Groceries, Salary, Rent"
                        required
                    />
                </div>
                <div>
                    <label for="addAmount" class="block text-gray-700 text-lg font-medium mb-2">Amount</label>
                    <input
                        type="number"
                        id="addAmount"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-200"
                        placeholder="e.g., 50.00"
                        step="0.01"
                        required
                    />
                </div>
                <div>
                    <label for="addDate" class="block text-gray-700 text-lg font-medium mb-2">Date</label>
                    <input
                        type="date"
                        id="addDate"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-200"
                        required
                    />
                </div>
                <p id="addError" class="text-red-500 mt-4 text-sm text-center"></p>
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-6">
                    <button
                        type="submit"
                        id="confirmAddTransactionBtn"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                    >
                        Confirm Add
                    </button>
                    <button
                        type="button"
                        id="cancelAddModalBtn"
                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2"
                    >
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>


    <div id="editTransactionModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full border border-blue-300">
            <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">Edit Transaction</h3>
            <form id="editTransactionForm" class="space-y-5">
                <div>
                    <label for="editDescription" class="block text-gray-700 text-lg font-medium mb-2">Description</label>
                    <input
                        type="text"
                        id="editDescription"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-200"
                        required
                    />
                </div>
                <div>
                    <label for="editAmount" class="block text-gray-700 text-lg font-medium mb-2">Amount</label>
                    <input
                        type="number"
                        id="editAmount"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-200"
                        step="0.01"
                        required
                    />
                </div>
                <div>
                    <label for="editDate" class="block text-gray-700 text-lg font-medium mb-2">Date</label>
                    <input
                        type="date"
                        id="editDate"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition duration-200"
                        required
                    />
                </div>
                <p id="editError" class="text-red-500 mt-4 text-sm text-center"></p>
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-6">
                    <button
                        type="submit"
                        id="saveEditBtn"
                        class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
                    >
                        Save Changes
                    </button>
                    <button
                        type="button"
                        id="cancelEditModalBtn"
                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2"
                    >
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCl6ubGzBbeiJv1vYSuGCFmeqvQRyQeDRM",
            authDomain: "expensetracker-e711b.firebaseapp.com",
            projectId: "expensetracker-e711b",
            storageBucket: "expensetracker-e711b.firebasestorage.app",
            messagingSenderId: "742011057310",
            appId: "1:742011057310:web:86e4f6ef2f48977dfdf78f"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        // Global variables for Firebase instances
        let db = getFirestore(app);
        let auth = getAuth(app);
        let currentUserId = null;
        let currentUserEmail = null;
        let allTransactions = [];
        let transactionBeingEditedId = null; // To store the ID of the transaction being edited
        let currentAddTransactionType = null; // To store 'income' or 'expense' when adding

        let transactionsDisplayLimit = 5; // NEW GLOBAL VARIABLE

        // Global variable to store the unsubscribe function for Firestore listener
        let unsubscribeFromTransactions = null;


        // Get DOM elements for Auth
        const authModal = document.getElementById('authModal');
        const authForm = document.getElementById('authForm');
        const authEmailInput = document.getElementById('authEmail');
        const authPasswordInput = document.getElementById('authPassword');
        const signInBtn = document.getElementById('signInBtn');
        const signUpBtn = document.getElementById('signUpBtn');
        const authError = document.getElementById('authError');
        const appContent = document.getElementById('appContent');
        const profileBtn = document.getElementById('profileBtn');

        // Get DOM elements for Finance Tracker (some changed/removed)
        const addExpenseBtn = document.getElementById('addExpenseBtn'); 
        const addIncomeBtn = document.getElementById('addIncomeBtn');   

        const transactionListDiv = document.getElementById('transactionList');
        const monthlyIncomeSpan = document.getElementById('monthlyIncome');
        const monthlyExpensesSpan = document.getElementById('monthlyExpenses');
        const monthlyBalanceSpan = document.getElementById('monthlyBalance');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const applyFilterBtn = document.getElementById('applyFilterBtn');
        const clearFilterBtn = document.getElementById('clearFilterBtn');
        const exportToExcelBtn = document.getElementById('exportToExcelBtn');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const currentUserIdSpan = document.getElementById('currentUserId');
        const loadMoreBtn = document.getElementById('loadMoreBtn'); // NEW DOM ELEMENT
        

        // New DOM elements for Add Transaction Modal
        const addTransactionModal = document.getElementById('addTransactionModal');
        const addModalTitle = document.getElementById('addModalTitle');
        const addTransactionForm = document.getElementById('addTransactionForm');
        const addDescriptionInput = document.getElementById('addDescription');
        const addAmountInput = document.getElementById('addAmount');
        const addDateInput = document.getElementById('addDate');
        const confirmAddTransactionBtn = document.getElementById('confirmAddTransactionBtn');
        const cancelAddModalBtn = document.getElementById('cancelAddModalBtn');
        const addError = document.getElementById('addError');


        // Existing DOM elements for Edit Transaction Modal
        const editTransactionModal = document.getElementById('editTransactionModal');
        const editTransactionForm = document.getElementById('editTransactionForm');
        const editDescriptionInput = document.getElementById('editDescription');
        const editAmountInput = document.getElementById('editAmount');
        const editDateInput = document.getElementById('editDate');
        const saveEditBtn = document.getElementById('saveEditBtn');
        const cancelEditModalBtn = document.getElementById('cancelEditModalBtn');
        const editError = document.getElementById('editError');


        // Modal elements for confirmations
        const confirmationModal = document.getElementById('confirmationModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const confirmActionBtn = document.getElementById('confirmActionBtn');
        const cancelActionBtn = document.getElementById('cancelActionBtn');

        // Function to show custom confirmation modal
        function showModal(title, message, onConfirm, confirmText = "Confirm", cancelText = "Cancel") {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            confirmActionBtn.textContent = confirmText;
            cancelActionBtn.textContent = cancelText;
            confirmationModal.classList.remove('hidden');

            let currentConfirmHandler = null;
            let currentCancelHandler = null;

            currentConfirmHandler = () => {
                onConfirm();
                confirmationModal.classList.add('hidden');
                confirmActionBtn.removeEventListener('click', currentConfirmHandler);
                cancelActionBtn.removeEventListener('click', currentCancelHandler);
                confirmActionBtn.textContent = "Confirm"; // Reset button texts
                cancelActionBtn.textContent = "Cancel";
            };

            currentCancelHandler = () => {
                confirmationModal.classList.add('hidden');
                confirmActionBtn.removeEventListener('click', currentConfirmHandler);
                cancelActionBtn.removeEventListener('click', currentCancelHandler);
                confirmActionBtn.textContent = "Confirm"; // Reset button texts
                cancelActionBtn.textContent = "Cancel";
            };

            // Remove existing listeners before adding new ones to prevent multiple calls
            confirmActionBtn.removeEventListener('click', window._tempConfirmHandler);
            cancelActionBtn.removeEventListener('click', window._tempCancelHandler);

            confirmActionBtn.addEventListener('click', currentConfirmHandler);
            cancelActionBtn.addEventListener('click', currentCancelHandler);

            window._tempConfirmHandler = currentConfirmHandler;
            window._tempCancelHandler = currentCancelHandler;
        }

        // --- Authentication Functions ---

        // Handle Sign In
        signInBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            authError.textContent = ''; // Clear previous errors

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Sign In Error:", error);
                authError.textContent = error.message;
            }
        });

        // Handle Sign Up
        signUpBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            authError.textContent = ''; // Clear previous errors

            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Sign Up Error:", error);
                authError.textContent = error.message;
            }
        });

        // Handle Profile Button click (now triggers logout modal)
        profileBtn.addEventListener('click', async () => {
            showModal(
                "User Profile",
                `You are logged in as: ${currentUserEmail}`,
                async () => {
                    try {
                        await signOut(auth);
                    } catch (error) {
                        console.error("Logout Error:", error);
                        showModal("Logout Error", "Failed to log out. Please try again.", () => {}, "Ok");
                    }
                },
                "Logout", // Text for the confirm button
                "Close"   // Text for the cancel button
            );
        });

        // --- Firebase Initialization and Auth State Listener ---
        window.onload = () => {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in
                    currentUserId = user.uid;
                    currentUserEmail = user.email || 'N/A'; // Use email or fallback
                    currentUserIdSpan.textContent = currentUserEmail;
                    userIdDisplay.classList.remove('hidden');
                    authModal.classList.add('hidden'); // Hide auth modal
                    appContent.classList.remove('hidden'); // Show app content
                    console.log("Logged in as:", currentUserEmail, "(UID:", currentUserId, ")");
                    transactionsDisplayLimit = 5; // Reset limit on login
                    // Start listening for data and store the unsubscribe function
                    unsubscribeFromTransactions = listenForTransactions();
                } else {
                    // User is signed out
                    // First, stop listening to old data if it exists
                    if (unsubscribeFromTransactions) {
                        unsubscribeFromTransactions();
                        unsubscribeFromTransactions = null;
                        console.log("Stopped listening to transactions.");
                    }
                    currentUserId = null;
                    currentUserEmail = null;
                    userIdDisplay.classList.add('hidden');
                    authModal.classList.remove('hidden'); // Show auth modal
                    appContent.classList.add('hidden'); // Hide app content
                    allTransactions = []; // Clear transactions when logged out
                    displayTransactions([]); // Clear displayed transactions
                    updateMonthlySummary(); // Reset summary
                    console.log("No user logged in.");
                }
            });
        };

        // Function to listen for real-time transaction updates from Firestore
        function listenForTransactions() {
            if (!db || !currentUserId) {
                console.error("Firestore DB or User ID not available for listening.");
                // Return a no-op unsubscribe function if conditions are not met
                return () => {};
            }

            const transactionsCollectionRef = collection(db, `users/${currentUserId}/transactions`);
            const q = query(transactionsCollectionRef);

            // onSnapshot returns an unsubscribe function
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const transactionsData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                transactionsData.sort((a, b) => new Date(b.date) - new Date(a.date));
                allTransactions = transactionsData;

                applyCurrentFilterAndDisplay();
                updateMonthlySummary();
            }, (error) => {
                console.error("Error fetching transactions in onSnapshot:", error);
                // Only show modal if still authenticated (i.e., not caused by logout cleanup)
                if (currentUserId) {
                    showModal("Data Fetch Error", "Failed to load transactions. Please check your internet connection.", () => {}, "Ok");
                }
            });

            return unsubscribe; // Return the unsubscribe function
        }

        // Function to display transactions based on current filters
        function applyCurrentFilterAndDisplay() {
            let filteredTransactions = [...allTransactions];

            const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

            let isFilterActive = false;
            if (startDate || endDate) {
                isFilterActive = true;
                filteredTransactions = filteredTransactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    const startOfDay = startDate ? new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate()) : null;
                    const endOfDay = endDate ? new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate(), 23, 59, 59, 999) : null;

                    const matchesStart = startOfDay ? transactionDate >= startOfDay : true;
                    const matchesEnd = endOfDay ? transactionDate <= endOfDay : true;
                    
                    return matchesStart && matchesEnd;
                });
            }
            
            // If no date filter is active, only show up to transactionsDisplayLimit
            let transactionsToShow = filteredTransactions;
            if (!isFilterActive) {
                transactionsToShow = filteredTransactions.slice(0, transactionsDisplayLimit);
                // Show/hide load more button
                if (transactionsDisplayLimit < filteredTransactions.length) {
                    loadMoreBtn.classList.remove('hidden');
                } else {
                    loadMoreBtn.classList.add('hidden');
                }
            } else {
                // If a filter is applied, always show all filtered results and hide load more
                loadMoreBtn.classList.add('hidden');
            }

            displayTransactions(transactionsToShow); // Pass the potentially sliced array
        }

        // Function to render transactions to the UI
        function displayTransactions(transactionsToDisplay) {
            transactionListDiv.innerHTML = ''; // Clear existing list

            if (transactionsToDisplay.length === 0) {
                transactionListDiv.innerHTML = '<p class="text-center text-gray-500 text-lg">No transactions to display.</p>';
                return;
            }

            transactionsToDisplay.forEach(transaction => {
                const listItem = document.createElement('div');
                // Ensure the main container is a flexbox and items are aligned
                listItem.classList.add('flex', 'justify-between', 'items-center', 'p-4', 'rounded-lg', 'shadow-sm', 'border', 'border-gray-200', 'flex-wrap', 'sm:flex-nowrap'); // Added flex-wrap for smaller screens

                const amountClass = transaction.type === 'expense' ? 'text-red-600' : 'text-green-600';
                const sign = transaction.type === 'expense' ? '-' : '+';

                listItem.innerHTML = `
                    <div class="flex flex-col flex-grow min-w-0 mr-4"> <span class="text-gray-800 font-semibold text-lg truncate">${transaction.description}</span> <span class="text-gray-500 text-sm">${transaction.date}</span>
                    </div>
                    <span class="${amountClass} font-bold text-xl mr-4 text-right flex-shrink-0"> ${sign} ₹${transaction.amount.toFixed(2)}
                    </span>
                    <div class="flex space-x-2 flex-shrink-0 ml-auto"> <button class="edit-btn bg-yellow-500 hover:bg-yellow-600 text-white p-2 rounded-md shadow-sm transition duration-200" data-id="${transaction.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                        </button>
                        <button class="delete-btn bg-red-500 hover:bg-red-600 text-white p-2 rounded-md shadow-sm transition duration-200" data-id="${transaction.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                `;
                transactionListDiv.appendChild(listItem);
            });

            // Attach event listeners to new buttons (delegation or direct after rendering)
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.currentTarget.dataset.id;
                    const transactionToEdit = allTransactions.find(t => t.id === id);
                    if (transactionToEdit) {
                        handleEditTransaction(transactionToEdit);
                    }
                };
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.currentTarget.dataset.id;
                    showModal(
                        "Confirm Deletion",
                        "Are you sure you want to delete this transaction? This action cannot be undone.",
                        () => handleDeleteTransaction(id),
                        "Delete",
                        "Cancel"
                    );
                };
            });
        }
        // Function to update monthly summary
        function updateMonthlySummary() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            let totalIncome = 0;
            let totalExpenses = 0;

            allTransactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date);
                if (transactionDate.getMonth() === currentMonth && transactionDate.getFullYear() === currentYear) {
                    if (transaction.type === 'income') {
                        totalIncome += transaction.amount;
                    } else if (transaction.type === 'expense') {
                        totalExpenses += transaction.amount;
                    }
                }
            });

            const netBalance = totalIncome - totalExpenses;

            monthlyIncomeSpan.textContent = `₹${totalIncome.toFixed(2)}`;
            monthlyExpensesSpan.textContent = `₹${totalExpenses.toFixed(2)}`;
            monthlyBalanceSpan.textContent = `₹${netBalance.toFixed(2)}`;

            // Change color of net balance based on value
            if (netBalance >= 0) {
                monthlyBalanceSpan.classList.remove('text-red-700');
                monthlyBalanceSpan.classList.add('text-blue-700');
            } else {
                monthlyBalanceSpan.classList.remove('text-blue-700');
                monthlyBalanceSpan.classList.add('text-red-700');
            }
        }

        // --- New Functions for Add Transaction Modal ---

        // Function to open the Add Transaction modal
        function openAddTransactionModal(type) {
            currentAddTransactionType = type;
            addModalTitle.textContent = `Add New ${type === 'income' ? 'Income' : 'Expense'}`;
            // Pre-fill date with today's date
            addDateInput.value = new Date().toISOString().slice(0, 10);
            addDescriptionInput.value = '';
            addAmountInput.value = '';
            addError.textContent = ''; // Clear previous errors
            addTransactionModal.classList.remove('hidden');
        }

        // Event listener for "Add Expense" button
        addExpenseBtn.addEventListener('click', () => {
            openAddTransactionModal('expense');
        });

        // Event listener for "Add Income" button
        addIncomeBtn.addEventListener('click', () => {
            openAddTransactionModal('income');
        });

        // Event listener for "Confirm Add" button inside the Add Transaction modal
        addTransactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!db || !currentUserId || !currentAddTransactionType) {
                console.error("Firebase not initialized, user not authenticated, or transaction type not set.");
                addError.textContent = "Error: Cannot add transaction. Please try again.";
                return;
            }

            const description = addDescriptionInput.value.trim();
            const amount = parseFloat(addAmountInput.value);
            const date = addDateInput.value;
            const type = currentAddTransactionType; // Use the stored type

            if (!description || isNaN(amount) || amount <= 0 || !date) {
                addError.textContent = "Please fill in all fields correctly. Amount must be a positive number.";
                return;
            }

            try {
                await addDoc(collection(db, `users/${currentUserId}/transactions`), {
                    description: description,
                    amount: amount,
                    date: date,
                    type: type,
                    userId: currentUserId,
                    timestamp: serverTimestamp()
                });
                console.log("Transaction successfully added!");
                resetAddModal(); // Close modal and reset fields
            } catch (error) {
                console.error("Error adding document: ", error);
                addError.textContent = "Failed to add transaction. Please try again.";
            }
        });

        // Event listener for "Cancel" button in the Add Transaction modal
        cancelAddModalBtn.addEventListener('click', () => {
            resetAddModal();
        });

        // Function to reset and hide the Add Transaction modal
        function resetAddModal() {
            addDescriptionInput.value = '';
            addAmountInput.value = '';
            addDateInput.value = '';
            addError.textContent = '';
            currentAddTransactionType = null;
            addTransactionModal.classList.add('hidden');
        }


        // --- Existing Functions for Edit/Delete ---

        // Function to handle editing a transaction (shows modal)
        function handleEditTransaction(transaction) {
            transactionBeingEditedId = transaction.id; // Store ID of transaction being edited
            editDescriptionInput.value = transaction.description;
            editAmountInput.value = transaction.amount;
            editDateInput.value = transaction.date;
            editError.textContent = ''; // Clear previous errors

            editTransactionModal.classList.remove('hidden'); // Show the edit modal
        }

        // Function to handle deleting a transaction
        async function handleDeleteTransaction(transactionId) {
            if (!db || !currentUserId) {
                console.error("Firebase not initialized or user not authenticated.");
                showModal("Error", "Firebase not ready. Please sign in.", () => {}, "Ok");
                return;
            }
            try {
                // Construct the document reference
                const docRef = doc(db, `users/${currentUserId}/transactions`, transactionId);
                await deleteDoc(docRef);
                console.log("Document successfully deleted!");
                // onSnapshot will automatically update the UI
            } catch (error) {
                console.error("Error removing document: ", error);
                showModal("Error", "Failed to delete transaction. Please try again.", () => {}, "Ok");
            }
        }

        // Function to reset the edit modal and related state
        function resetEditModal() {
            transactionBeingEditedId = null;
            editDescriptionInput.value = '';
            editAmountInput.value = '';
            editDateInput.value = '';
            editError.textContent = '';
            editTransactionModal.classList.add('hidden'); // Hide the edit modal
        }

        // Event listener for Save Changes button in edit modal
        saveEditBtn.addEventListener('click', async (e) => {
            e.preventDefault();

            if (!db || !currentUserId || !transactionBeingEditedId) {
                console.error("Cannot update: Firebase not ready or no transaction selected for edit.");
                editError.textContent = "Error: No transaction selected for edit.";
                return;
            }

            const description = editDescriptionInput.value.trim();
            const amount = parseFloat(editAmountInput.value);
            const date = editDateInput.value;

            if (!description || isNaN(amount) || amount <= 0 || !date) {
                editError.textContent = "Please fill in all fields correctly. Amount must be a positive number.";
                return;
            }

            try {
                const docRef = doc(db, `users/${currentUserId}/transactions`, transactionBeingEditedId);
                await updateDoc(docRef, {
                    description: description,
                    amount: amount,
                    date: date,
                    // Note: Type is not changed during edit to keep it consistent
                });
                console.log("Document successfully updated!");
                resetEditModal(); // Close modal and reset fields
            } catch (error) {
                console.error("Error updating document: ", error);
                editError.textContent = "Failed to update transaction. Please try again.";
            }
        });

        // Event listener for Cancel button in edit modal
        cancelEditModalBtn.addEventListener('click', () => {
            resetEditModal(); // Close modal and reset fields
        });

        // Event listener for Apply Filter button
        applyFilterBtn.addEventListener('click', applyCurrentFilterAndDisplay);

        // Event listener for Clear Filter button
        clearFilterBtn.addEventListener('click', () => {
            startDateInput.value = '';
            endDateInput.value = '';
            transactionsDisplayLimit = 5; // Reset limit on clear filter
            applyCurrentFilterAndDisplay();
        });

        // Event listener for Load More button
        loadMoreBtn.addEventListener('click', () => {
            transactionsDisplayLimit += 10; // Increase limit by 10
            applyCurrentFilterAndDisplay(); // Re-apply filter and re-render
        });

        // Function to export data to CSV
        exportToExcelBtn.addEventListener('click', () => {
            if (allTransactions.length === 0) {
                showModal("No Data", "There is no data to export.", () => {}, "Ok");
                return;
            }

            // Define CSV header
            const header = ['Type', 'Description', 'Amount', 'Date', 'UserID'];
            let csvContent = header.join(',') + '\n';

            // Add rows
            allTransactions.forEach(transaction => {
                const row = [
                    transaction.type,
                    `"${transaction.description.replace(/"/g, '""')}"`,
                    transaction.amount.toFixed(2),
                    transaction.date,
                    transaction.userId
                ];
                csvContent += row.join(',') + '\n';
            });

            // Create a Blob and a download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'finance_transactions.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        });

        // PWA: Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered! Scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
        // End PWA registration
    </script>
</body>
</html>